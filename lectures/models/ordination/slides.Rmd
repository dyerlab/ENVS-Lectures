---
title: "Regression"
output:
  xaringan::moon_reader:
    lib_dir: libs
    css: ["default", "../../css/slide_model_styles.css", "../../css/slide_fonts.css"]
    seal: false
    nature:
      titleSlideClass: ["center","middle"]
      highlightStyle: default
      highlightLines: true
      ratio: "16:9"
      countIncrementalSlides: false
---
class: left, middle, inverse
background-image: url("https://live.staticflickr.com/65535/50559539697_1c35d0a56a_o_d.png")
background-size: cover


```{r setup, include=FALSE}
library( knitr )
library( reshape2 )
library( tidyverse )
library( kableExtra )
library( fontawesome )
knitr::opts_chunk$set( fig.retina = 3, 
                       warning = FALSE, 
                       message = FALSE,
                       fig.align="center")

theme_set( theme_minimal( base_size = 22) )
```


# .black[Ordination Techniques `r fa('braille', fill="#FDD545")` ]

&nbsp;

### .yellow[.fancy[Viewing High-Dimensional Data In Low-Dimensional Spaces]]

&nbsp;

&nbsp;

---
class: inverse, middle
background-image: url("background.png")
background-position: right
background-size: auto


# .orange[Spatial <br> Autocorrelation]

## .fancy[Self-similarity in space.]





---
class: middle, center

![](https://live.staticflickr.com/65535/51206415778_cbcfde8417_c_d.jpg)


---
class: middle, center

![](https://live.staticflickr.com/65535/51206209856_ff6cc1e21b_c_d.jpg)



---
class: middle, center

![](https://live.staticflickr.com/65535/51205518387_9a282276e8_c_d.jpg)



---
class: middle, center

![](https://live.staticflickr.com/65535/51206228671_cde5f8ff6a_c_d.jpg)


---
class: middle, center

![](https://live.staticflickr.com/65535/51206434673_a227c2dd48_c_d.jpg)

---
class: middle, center

![](https://live.staticflickr.com/65535/51206209876_fac5d21f18_c_d.jpg)



---
class: middle, center

![](https://live.staticflickr.com/65535/51207277255_f6c7737ecd_c_d.jpg)





---
class: middle, center

![](https://live.staticflickr.com/65535/51206994379_1117dc4e90_c_d.jpg)






---
class: middle, center

![](https://live.staticflickr.com/65535/51205499692_8930c96040_c_d.jpg)





---
class: middle, center

![](https://live.staticflickr.com/65535/51207277285_e4bb978743_c_d.jpg)




---
class: middle, center

![](https://live.staticflickr.com/65535/51207277345_391091e168_c_d.jpg)


---

# An Example from *Cornus*


.pull-left[
```{r}
library( gstudio )
data(cornus)
summary( cornus )
```
]

.pull-right[
```{r echo=FALSE}
cornus$Population <- factor( cornus$Population)

ggplot( cornus, aes(X.Coordinate, Y.Coordinate, color=Population) ) + geom_point() + coord_equal() + xlab("Easting") + ylab("Northing")
```

]

---

# Spatial Autocorrelation

![](https://live.staticflickr.com/65535/51207391795_a656b2839e_c_d.jpg)


--- 

# Estimating Spatial Bins

.pull-left[
To construct a spatial autocorrelation, we need to find groups of individuals who are separated by a `lag` or `bin` (e.g., that can all be grouped into a *distance class*).  


- Ecological  

- Euclidean  

- Other  

]


.pull-right[
```{r}
coords <- strata_coordinates(cornus, stratum = "SampleID", longitude = "X.Coordinate", latitude="Y.Coordinate")
P <- strata_distance(coords, mode="Euclidean")
G <- genetic_distance(cornus, mode="AMOVA")
```
]


---

```{r}
df <- data.frame( Physical=P[lower.tri(P)], Genetic=G[lower.tri(G)])
ggplot( df, aes(Physical,Genetic)) + geom_point() + stat_smooth(method="gam")
```

---

# Overall Correlation - The Mantel

```{r}
cor.test(df$Physical, df$Genetic)
```




---

```{r}
df %>% filter( Physical < 25 ) -> df1
ggplot( df[ df$Physical < 25,], aes(Physical,Genetic)) + geom_point() + stat_smooth(method="loess") + geom_jitter()
```


---

# Correlation At Bins - The Spatially Restriced Mantel

```{r}
cor.test(df1$Physical, df1$Genetic)
```




---

# Estimate the Correlgrams

.pull-left[
Each entry in the correlogram is based upon the interclass correlation statistic:

\begin{equation}
r^h = \frac{\sum_{i\ne j}^K x_{ij}^hc_{ij}^h}{\sum_{i=1}^Kx_{ii}^hc_{ii}^h}
\end{equation}



```{r eval=FALSE}
df <- genetic_autocorrelation(P,G,bins=seq(0,1000,by=100),perms=999)
df$Significant <- df$P <= 0.05
ggplot( df, aes(x=To,y=R)) + 
  geom_line() + 
  geom_point( aes(color=Significant), size=4) + 
  geom_abline(slope=0,intercept=0, linetype=2) +
  xlab("Physical Separation") + 
  ylab("Genetic Correlation")
```


]


.pull-right[
```{r autocorr, echo=FALSE, cache=TRUE}
df <- genetic_autocorrelation( P,
                               G,
                               bins=seq(0,1000,by=100),
                               perms=999)
df$Significant <- df$P <= 0.05
ggplot( df, aes(x=To,y=R)) + geom_line() + 
  geom_point( aes(color=Significant), size=4) + 
  geom_abline(slope=0,intercept=0, linetype=2) +
  xlab("Physical Separation") + ylab("Genetic Correlation")
```
]

---
class: middle, center

![](https://live.staticflickr.com/65535/51206415968_fd33982962_c_d.jpg)

---
class: inverse, middle
background-image: url("background.png")
background-position: right
background-size: auto

# .orange[Eigen Structure]

## .fancy[Please define an eigenvalue... I dare you.]






---
class: middle, center

![](https://live.staticflickr.com/65535/51206994389_bdd3824fda_c_d.jpg)


---
class: middle, center

![](https://live.staticflickr.com/65535/51207296305_4f7428786d_c_d.jpg)








---
class: middle, center

![](https://live.staticflickr.com/65535/51206415998_3527374bc2_c_d.jpg)




---
class: middle, center

![](https://live.staticflickr.com/65535/51206210046_4cc91ca0ea_c_d.jpg)




---
class: middle, center

![](https://live.staticflickr.com/65535/51206975949_e08e018ffe_c_d.jpg)




---
class: middle, center

![](https://live.staticflickr.com/65535/51206975979_22ceef0be6_c_d.jpg)



---
class: middle, center

![](https://live.staticflickr.com/65535/51206994494_bcd4fb98c3_c_d.jpg)

---

```{r}
data( arapat )
mv_genos <- to_mv( arapat ) 
fit.pca <- princomp(mv_genos,cor = TRUE)
names( fit.pca )
```

---

```{r eval=FALSE}
summary( fit.pca )
```

```{r echo=FALSE}
pcaPrint <- function (x, digits = 3, loadings = x$print.loadings, cutoff = x$cutoff,n, ...) 
{
    #Check for sensible value of n; default to full output
    if (missing(n) || n > length(x$sdev) || n < 1){n <- length(x$sdev)}
    vars <- x$sdev^2
    vars <- vars/sum(vars)
    cat("Importance of components:\n")
    print(rbind(`Standard deviation` = x$sdev[1:n], `Proportion of Variance` = vars[1:n], 
        `Cumulative Proportion` = cumsum(vars)[1:n]))
    if (loadings) {
        cat("\nLoadings:\n")
        cx <- format(round(x$loadings, digits = digits))
        cx[abs(x$loadings) < cutoff] <- paste(rep(" ", nchar(cx[1, 
            1], type = "w")), collapse = "")
        print(cx[,1:n], quote = FALSE, ...)
    }
    invisible(x)
}

pcaPrint(summary(fit.pca, loadings = FALSE, cutoff = 0.2), digits = 2,n = 30)
```

---

```{r}
plot( fit.pca )
```

---
.pull-left[

# Visualization

```{r eval=FALSE}

predict( fit.pca ) %>%
  data.frame() %>%
  mutate( Species = arapat$Species) -> pred.pca 

ggplot( pred.pca, aes(Comp.1,Comp.2,color=Species) ) + 
  geom_point()  + 
  theme( legend.position = "none")
```
]

.pull-right[

<p>&nbsp;</p>

```{r echo=FALSE}
predict( fit.pca ) %>%
  data.frame() %>%
  mutate( Species = arapat$Species) -> pred.pca 

ggplot( pred.pca, aes(Comp.1,Comp.2,color=Species) ) + 
  geom_point()  + 
  theme( legend.position = "none")
```
]



---

# Principal Components Analysis on Frequencies

Just like working on raw data, but coalescing all the individuals into single populations defined by allele frquency matrices.


```{r}
freqs <- frequency_matrix(arapat)
head( freqs[,1:19] )
```


---

# Principal Components Analysis on Frequencies

Just like working on raw data, but coalescing all the individuals into single populations defined by allele frquency matrices.


```{r}
F <- as.matrix( freqs[,2:59])
rownames( F ) <- freqs$Stratum
fit.pca_freq <- prcomp( F, center = TRUE )
```


---

```{r}
summary( fit.pca_freq )
```


---

.pull-left[
# PCA on Frequencies


Just like working on raw data, but coalescing all the individuals into single populations defined by allele frquency matrices.

```{r eval=FALSE}
predict( fit.pca_freq ) %>%
  data.frame() %>%
  mutate( Population = freqs$Stratum ) %>%
  ggplot( aes(PC1,PC2) ) + 
  geom_text( aes(label=Population))
```
]

.pull-right[

<p>&nbsp;</p>

```{r echo=FALSE}
predict( fit.pca_freq ) %>%
  data.frame() %>%
  mutate( Population = freqs$Stratum ) %>%
  ggplot( aes(PC1,PC2) ) + 
  geom_text( aes(label=Population))
```
]




---



.pull-left[

# Detailed Visulizations

```{r eval=FALSE}
library( factoextra )
fviz_pca_biplot( fit.pca_freq )
```
]

.pull-right[
<p>&nbsp;</p>
```{r echo=FALSE}
library( factoextra )
fviz_pca_biplot( fit.pca_freq )
```
]






---

# Principal Coordinate Analysis

Like PCA but using distance matrices instead of raw data.

```{r}
D.Euc <- genetic_distance(arapat, mode="Euclidean")
dim(D.Euc)
fit.gendist <- prcomp( D.Euc, center = TRUE)
```


---
```{r}
summary( fit.gendist )
```



---

```{r echo=FALSE}
fviz_pca_biplot( fit.gendist )
```





---
class: inverse, middle
background-image: url("background.png")
background-position: right
background-size: auto


# .orange[Hierarchical Clustering]

### .fancy[Stand next to your buddy.]



---
# Clustering


.pull-left[
A technique to build a representation of similarity between objects.

- Supervised  

- Unsupervised

- Individual or Group Based
]


.pull-right[
![From www.nature.com/articles/s41467-020-20507-3](https://live.staticflickr.com/65535/51734955871_9c76562bd3_w_d.jpg)
]



---

![Help File for hclust](https://live.staticflickr.com/65535/51735192018_1444d8d533_o_d.png) 


---

# Visualizing From Distance Views

Requires that the `matrix` objects actually be turned into `dist` objects (which are `matrix` objects with constraints).

```{r}
dist( D.Euc[1:7,1:7] )
```


---

# Visualizing From Distance Views


.pull-left[
```{r}
d <- dist( D.Euc )
h <- hclust( d )
h
```
]

--

.pull-right[
```{r}
plot(h)
```
]




---

# Interactive Plots

```{r}
library( networkD3 )
dendroNetwork( h, height=400, zoom=TRUE,textColour = c("red","green","orange","blue")[cutree(h,4)])
```










---

class: middle
background-position: right
background-size: auto

.center[

# Questions?


![Peter Sellers](https://live.staticflickr.com/65535/50382906427_2845eb1861_o_d.gif+)
]

<p>&nbsp;</p>

.bottom[ If you have any questions for about the content presented herein, please feel free to [submit them to me](mailto://rjdyer@vcu.edu) and I'll get back to you as soon as possible.]


